%transform wave to amplitude and phase
function [amp74,amp78,amp80,amp83,pha74,pha78,pha80,pha83]=load_wave_sys1_FPGA_ref_phase(bgdata,source,detect,sddist_matrix)

if length(bgdata) > 9216
    data_74=bgdata(1:4608,1:detect+1);          %512*9=4608
    data_78=bgdata(4608*1+1:4608*2,1:detect+1);
    data_80=bgdata(4608*2+1:4608*3,1:detect+1);
    data_83=bgdata(4608*3+1:4608*4,1:detect+1);

    for i=1:source
        eval(['data74_s',num2str(i),'=data_74(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
        eval(['data78_s',num2str(i),'=data_78(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
        eval(['data80_s',num2str(i),'=data_80(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
        eval(['data83_s',num2str(i),'=data_83(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
    end
else
    data_74=bgdata(1:2304,1:detect+1);          %256*9=2304
    data_78=bgdata(2304*1+1:2304*2,1:detect+1);
    data_80=bgdata(2304*2+1:2304*3,1:detect+1);
    data_83=bgdata(2304*3+1:2304*4,1:detect+1);

    for i=1:source
        eval(['data74_s',num2str(i),'=data_74(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
        eval(['data78_s',num2str(i),'=data_78(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
        eval(['data80_s',num2str(i),'=data_80(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
        eval(['data83_s',num2str(i),'=data_83(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
    end
end

for ii=1:source
    eval(['ref=data74_s',num2str(ii),'(:,15);']);
    ref=ref-mean(ref);
    ref_h = hilbert(ref);
    ref_phase=mean(unwrap(angle(ref_h)));
   
    for jj=1:detect
        eval(['wv=data74_s',num2str(ii),'(:,',num2str(jj),');'])
        wv_h=hilbert(wv);
        amp = mean(abs(wv_h));
        phase= mean(unwrap(angle(wv_h)));
        amp74(ii,jj)=amp/1000;   %convert from mV to V 
        pha74(ii,jj)=mod(ref_phase-phase,2*pi);
    end
end

for ii=1:source
    eval(['ref=data78_s',num2str(ii),'(:,15);']);
    ref=ref-mean(ref);
    ref_h = hilbert(ref);
    ref_phase=mean(unwrap(angle(ref_h)));
   
    for jj=1:detect
        eval(['wv=data78_s',num2str(ii),'(:,',num2str(jj),');'])
        wv_h=hilbert(wv);
        amp = mean(abs(wv_h));
        phase= mean(unwrap(angle(wv_h)));
        amp78(ii,jj)=amp/1000;   %convert from mV to V 
        pha78(ii,jj)=mod(ref_phase-phase,2*pi);
    end
end

for ii=1:source
    eval(['ref=data80_s',num2str(ii),'(:,15);']);
    ref=ref-mean(ref);
    ref_h = hilbert(ref);
    ref_phase=mean(unwrap(angle(ref_h)));
   
    for jj=1:detect
        eval(['wv=data80_s',num2str(ii),'(:,',num2str(jj),');'])
        wv_h=hilbert(wv);
        amp = mean(abs(wv_h));
        phase= mean(unwrap(angle(wv_h)));
        amp80(ii,jj)=amp/1000;   %convert from mV to V 
        pha80(ii,jj)=mod(ref_phase-phase,2*pi);
    end
end

for ii=1:source
    eval(['ref=data83_s',num2str(ii),'(:,15);']);
    ref=ref-mean(ref);
    ref_h = hilbert(ref);
    ref_phase=mean(unwrap(angle(ref_h)));
   
    for jj=1:detect
        eval(['wv=data83_s',num2str(ii),'(:,',num2str(jj),');'])
        wv_h=hilbert(wv);
        amp = mean(abs(wv_h));
        phase= mean(unwrap(angle(wv_h)));
        amp83(ii,jj)=amp/1000;   %convert from mV to V 
        pha83(ii,jj)=mod(ref_phase-phase,2*pi);
    end
end

cross_74=[
-2.4821	-1.9881	-1.8421	0.8612	-1.9879	1.5935	-0.0420	-1.8057	2.6196	-2.6728	1.9624	-1.8932	-2.3936	-2.9697
-2.6369	-2.0609	-2.2371	0.7994	-2.0133	1.4456	-0.2359	-1.9873	2.6033	-2.9460	1.7271	-2.0888	-2.7434	-3.0165
-2.5040	-2.0389	-2.0782	0.6935	-2.2974	1.4537	-0.4023	-1.7792	2.6016	-2.7966	1.8407	-2.1291	-2.8946	-3.2007
-2.3876	-2.1509	-2.1780	0.7626	-2.1058	1.5529	-0.1172	-2.0097	2.5645	-2.8621	1.9107	-2.0255	-2.8612	-3.1494
-2.4873	-1.9350	-2.0350	0.8682	-2.1605	1.5958	-0.0395	-2.0987	2.5230	-2.7491	1.8927	-1.8101	-2.7006	-2.9998
-2.4202	-1.8714	-2.0572	0.9728	-1.8021	1.4709	-1.5020	-2.1313	2.5754	-2.7773	2.0956	-2.0811	-2.6411	-2.9744
-2.4252	-2.0628	-1.9586	0.8678	-1.9158	1.4265	-1.4283	-2.2049	2.7546	-2.7481	1.9671	-2.1868	-2.7751	-2.9206
-2.3795	-2.0561	-2.1142	1.0170	-1.8739	1.6192	-1.7172	-1.9354	2.7289	-2.7114	1.9767	-1.9993	-2.6658	-2.8640
-2.5086	-2.0394	-2.0195	1.0355	-1.8560	1.5960	-1.4777	-2.0257	2.6330	-2.6885	1.9153	-1.8326	-2.5934	-3.0480
];

slope_74=[
0.4958   	0.5507   	0.5162   	0.4766    	0.6061   	0.4815    	0.4903      0.4951     	0.5191      0.5308   	0.4881     	0.5655      0.4747      0.5134      
0.5124   	0.5442   	0.5643   	0.4721    	0.5918      0.4928      0.5102   	0.5107   	0.5086      0.5668      0.5139      0.5826      0.5175    	0.5026   
0.4861   	0.5345      0.5296   	0.4911      0.6460     	0.4900      0.5372      0.4697      0.5118     	0.5394      0.4968      0.5905      0.5470     	0.5329       
0.4736     	0.5588   	0.5533      0.4919      0.6160      0.4802      0.4899   	0.5118   	0.5199      0.5547      0.4830      0.5751      0.5419   	0.5256   
0.4969      0.5285      0.5327      0.4747      0.6316      0.4726      0.4819      0.5394      0.5358      0.5362     	0.4923      0.5369   	0.5172   	0.5096   
0.4974      0.5299     	0.5516      0.4614      0.5718      0.5056      0.5182      0.5329   	0.5369      0.5591      0.4653      0.6045      0.5174     	0.5146   
0.4903     	0.5568      0.5247      0.4697      0.5824      0.5018      0.5001     	0.5400      0.4991      0.5438      0.4904      0.6159      0.5359      0.4942     
0.4859     	0.5642      0.5648      0.4665      0.5910     	0.4867      0.5683      0.5082      0.5220      0.5549     	0.5026      0.5961     	0.5291   	0.4991   
0.5120   	0.5620   	0.5489      0.4647      0.5875     	0.4907    	0.5166      0.5232     	0.5338    	0.5494      0.5086    	0.5661   	0.5202   	0.5340
];

cross_78=[
-0.4842	-0.1799	-0.2087	2.5485	-0.2377	-2.9554	1.5974	-0.1505	-1.7904	-1.0150	-2.6461	-0.1069	-0.8521	-1.1847
-0.6715	-0.3033	-0.4048	2.5327	-0.3531	-3.0941	1.3552	-0.3577	-1.8869	-1.1116	-2.7285	-0.3144	-0.9793	-1.1854
-0.7811	-0.3588	-0.4496	2.4424	-0.5181	-2.9568	1.2350	-0.1239	-1.7892	-1.1383	-2.6177	-0.4477	-0.8700	-1.1972
-0.6308	-0.3754	-0.4645	2.6110	-0.4438	-2.9982	1.3424	-0.4112	-1.8976	-1.1014	-2.6582	-0.2376	-0.9319	-1.3317
-0.7547	-0.2200	-0.3836	2.5171	-0.3400	-3.0456	1.4956	-0.3570	-1.7649	-1.1028	-2.6140	-0.1427	-1.0417	-1.3022
-0.5995	-0.1883	-0.2697	2.6633	-0.0688	-2.9427	0.6553	-0.4667	-1.7547	-1.0868	-2.6635	-0.1573	-0.8128	-1.1132
-0.5463	-0.2906	-0.3723	2.5849	-0.1882	-3.0575	0.4870	-0.5025	-1.7584	-1.1981	-2.6093	-0.2481	-1.1603	-1.0650
-0.4370	-0.3465	-0.2941	2.7860	-0.0638	-2.9428	0.4672	-0.3742	-1.5209	-1.0214	-2.5060	-0.1308	-0.8427	-1.0835
-0.6081	-0.1597	-0.2433	2.7146	-0.1292	-2.9249	0.4950	-0.4037	-1.6438	-1.0482	-2.6343	-0.0322	-0.8659	-1.0968
];

slope_78=[
0.4314   	0.5225   	0.5166   	0.4719    	0.5884   	0.4704   	0.5016    	0.5017   	0.4871   	0.5372   	0.4871   	0.5493   	0.5049   	0.4899   
0.4511     	0.5228   	0.5310   	0.4584    	0.5914   	0.4784   	0.5257      0.5188      0.4857      0.5401      0.4850   	0.5651   	0.5097      0.4724      
0.4713   	0.5276     	0.5336      0.4754      0.6207      0.4512      0.5440      0.4686      0.4683   	0.5420     	0.4668     	0.5853     	0.4849      0.4709      
0.4502   	0.5346   	0.5392     	0.4569      0.6123     	0.4670      0.5285      0.5187      0.4931     	0.5379      0.4714      0.5553     	0.4978     	0.4964     
0.4783   	0.5124   	0.5300   	0.4748      0.5968     	0.4762      0.5090    	0.5257      0.4753      0.5424      0.4700      0.5394      0.5214      0.5021      
0.4609      0.5197     	0.5217     	0.4532      0.5552   	0.4656      0.4255      0.5298      0.4807      0.5542      0.4887      0.5542      0.4962      0.4741      
0.4451     	0.5337     	0.5353   	0.4605      0.5674      0.4760      0.4512      0.5297      0.4780      0.5658      0.4805     	0.5667      0.5482      0.4569      
0.4293      0.5516   	0.5322      0.4467      0.5607     	0.4763     	0.4712      0.5246      0.4522     	0.5498      0.4749      0.5601      0.5061      0.4772      
0.4659     	0.5199      0.5224     	0.4603      0.5718   	0.4729      0.4581    	0.5284      0.4699     	0.5543      0.4960     	0.5426      0.5089   	0.4786
];

cross_80=[
0.3742	0.5856	0.6395	-2.7344	0.5536	-2.0235	2.4105	0.6766	-0.7850	-0.1141	-1.7448	0.6446	0.1295	-0.2866
0.2525	0.5599	0.5104	-2.8073	0.5868	-2.2377	2.2362	0.5339	-0.9331	-0.3885	-1.9446	0.5465	-0.1970	-0.3268
0.2243	0.4530	0.3680	-2.8505	0.3234	-2.1308	2.1457	0.5958	-0.9078	-0.4703	-1.7286	0.3411	-0.2051	-0.3593
0.2707	0.4362	0.3355	-2.7221	0.4458	-2.0986	2.1160	0.3926	-1.0240	-0.2830	-1.8052	0.5309	0.0503	-0.3885
0.2216	0.5922	0.4754	-2.7613	0.4797	-2.1585	2.3328	0.4919	-0.9423	-0.2916	-1.7978	0.6053	-0.2083	-0.3393
0.2855	0.5152	0.6092	-2.5760	0.6832	-2.1369	1.4487	0.5173	-0.8132	-0.2348	-1.7862	0.6955	0.0604	-0.1776
0.3210	0.5599	0.4512	-2.7850	0.6105	-2.1554	1.2951	0.3341	-0.8408	-0.4045	-1.7241	0.5466	-0.2787	-0.2522
0.3703	0.5122	0.4966	-2.5250	0.7335	-2.0216	1.1895	0.5057	-0.6462	-0.2909	-1.7451	0.6744	0.0134	-0.2541
0.2510	0.5930	0.5152	-2.6085	0.6874	-2.0459	1.3152	0.4901	-0.7688	-0.2520	-1.8501	0.6127	-0.2106	-0.2596
];

slope_80=[
0.4510	0.5545	0.5366	0.4707	0.6162	0.4793	0.5247	0.5248	0.4771	0.5442	0.4989	0.5825	0.5022	0.5041
0.4603	0.5386	0.5367	0.4680	0.5924	0.5006	0.5409	0.5298	0.4847	0.5802	0.5174	0.5818	0.5397	0.4903
0.4634	0.5510	0.5566	0.4736	0.6381	0.4790	0.5506	0.5090	0.4834	0.5899	0.4821	0.6118	0.5399	0.4944
0.4643	0.5584	0.5662	0.4643	0.6229	0.4825	0.5626	0.5484	0.5061	0.5622	0.4924	0.5865	0.4969	0.5050
0.4753	0.5352	0.5455	0.4705	0.6189	0.4901	0.5289	0.5432	0.4990	0.5654	0.4985	0.5744	0.5462	0.5026
0.4736	0.5622	0.5341	0.4411	0.5899	0.4943	0.4577	0.5316	0.4833	0.5719	0.5056	0.5737	0.5110	0.4805
0.4617	0.5486	0.5556	0.4713	0.5921	0.4888	0.4797	0.5499	0.4841	0.5912	0.4942	0.5920	0.5623	0.4844
0.4566	0.5650	0.5570	0.4468	0.5847	0.4845	0.5148	0.5390	0.4677	0.5904	0.5134	0.5858	0.5284	0.5021
0.4845	0.5517	0.5542	0.4631	0.5917	0.4880	0.4840	0.5396	0.4852	0.5827	0.5278	0.5969	0.5692	0.5025
];

cross_83=[
0.9428	1.3494	1.2483	-2.1693	1.1491	-1.5435	3.0167	1.3103	-0.1962	0.5807	-1.1307	1.4564	0.8071	0.4472
0.9676	1.1567	1.0595	-2.3165	1.1631	-1.6411	2.7717	1.1104	-0.2282	0.3419	-1.3709	1.1353	0.4122	0.2295
0.8239	1.0253	1.0470	-2.2054	1.0785	-1.5467	2.6629	1.4191	-0.3011	0.2005	-1.2563	1.0675	0.5011	0.2759
0.8415	1.0691	1.0403	-2.1208	1.0960	-1.4835	2.7538	1.1220	-0.2862	0.3160	-1.1547	1.1225	0.3632	0.2647
0.8715	1.2439	1.0639	-2.2024	1.1808	-1.5066	2.8231	1.1775	-0.2563	0.4035	-1.3043	1.1504	0.5420	0.2793
0.9607	1.1878	1.3050	-2.0345	1.3163	-1.5535	1.9895	1.0339	-0.2532	0.4361	-1.2796	1.2497	0.5865	0.3372
0.8655	1.1488	1.1892	-2.2412	1.2173	-1.5381	1.8704	0.9448	-0.1985	0.2316	-1.1495	1.2577	0.5567	0.3993
0.9630	1.1098	1.1647	-2.0208	1.3157	-1.4423	1.9578	0.9999	0.0183	0.4460	-1.1634	1.3718	0.6925	0.3933
0.8617	1.2277	1.1087	-2.0825	1.2240	-1.3574	1.9182	1.1524	-0.1430	0.5241	-1.1377	1.3407	0.6702	0.3074
];

slope_83=[
0.4180	0.4876	0.4987	0.4397	0.5806	0.4620	0.4794	0.4725	0.4289	0.4828	0.4460	0.4988	0.4427	0.4307
0.4011	0.5051	0.5108	0.4462	0.5618	0.4639	0.5110	0.4920	0.4200	0.5130	0.4747	0.5401	0.4967	0.4506
0.4251	0.5228	0.5084	0.4285	0.5753	0.4450	0.5256	0.4281	0.4344	0.5391	0.4578	0.5494	0.4782	0.4386
0.4284	0.5172	0.5109	0.4240	0.5761	0.4391	0.5159	0.4862	0.4359	0.5203	0.4374	0.5440	0.5057	0.4456
0.4274	0.4913	0.5118	0.4392	0.5646	0.4434	0.5088	0.4838	0.4363	0.5079	0.4705	0.5415	0.4742	0.4522
0.4222	0.5143	0.4792	0.4147	0.5457	0.4594	0.4235	0.5044	0.4470	0.5185	0.4775	0.5390	0.4792	0.4482
0.4328	0.5156	0.4947	0.4422	0.5549	0.4477	0.4406	0.5048	0.4307	0.5444	0.4545	0.5303	0.4781	0.4306
0.4211	0.5313	0.5099	0.4265	0.5534	0.4508	0.4359	0.5140	0.4067	0.5219	0.4684	0.5227	0.4694	0.4462
0.4430	0.5120	0.5199	0.4367	0.5672	0.4340	0.4347	0.4847	0.4335	0.5085	0.4600	0.5294	0.4779	0.4629
];

% version 4, shift the change
 cro_74=[0 0 0 0 -0.2 0 0 0.1 -1.4 0 -0.7 -0.1 0 0.7];
 cro_78=[0 0 0 0 -0.1 0 0 0.2 -1.2 0 -0.7 -0.1 0 0.7];
 cro_80=[0 0 0 0 -0.2 0 0 0.2 -1.0 0 -0.8 -0.1 0 0.7];
 cro_83=[0 0 0 0 -0.1 0 0 0.2 -1.2 0 -0.8 -0.1 0 0.7];
 
 for ii=1:source
    for jj=1:detect
        pha=pha74(ii,jj);
        temp=polyval([mean(slope_74(:,jj)) mean(cross_74(:,jj))],sddist_matrix(ii,jj));
        if pha>temp+pi
            pha74(ii,jj)=pha-2*pi;
        end
        if pha<temp-pi
            pha74(ii,jj)=pha+2*pi;
        end
        pha74(ii,jj)=pha74(ii,jj)-mean(cross_74(:,jj))+cro_74(jj);
    end
end

for ii=1:source
    for jj=1:detect
        pha=pha78(ii,jj);
        temp=polyval([mean(slope_78(:,jj)) mean(cross_78(:,jj))],sddist_matrix(ii,jj));
        if pha>temp+pi
            pha78(ii,jj)=pha-2*pi;
        end
        if pha<temp-pi
            pha78(ii,jj)=pha+2*pi;
        end
        pha78(ii,jj)=pha78(ii,jj)-mean(cross_78(:,jj))+cro_78(jj);
    end    
end

 for ii=1:source
    for jj=1:detect
        pha=pha80(ii,jj);
        temp=polyval([mean(slope_80(:,jj)) mean(cross_80(:,jj))],sddist_matrix(ii,jj));
        if pha>temp+pi
            pha80(ii,jj)=pha-2*pi;
        end
        if pha<temp-pi
            pha80(ii,jj)=pha+2*pi;
        end
        pha80(ii,jj)=pha80(ii,jj)-mean(cross_80(:,jj))+cro_80(jj);
    end
 end

 for ii=1:source
    for jj=1:detect
        pha=pha83(ii,jj);
        temp=polyval([mean(slope_83(:,jj)) mean(cross_83(:,jj))],sddist_matrix(ii,jj));
        if pha>temp+pi
            pha83(ii,jj)=pha-2*pi;
        end
        if pha<temp-pi
            pha83(ii,jj)=pha+2*pi;
        end
        pha83(ii,jj)=pha83(ii,jj)-mean(cross_83(:,jj))+cro_83(jj);
    end
 end       
