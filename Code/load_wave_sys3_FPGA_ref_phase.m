%transform wave to amplitude and phase
function [amp74,amp78,amp80,amp83,pha74,pha78,pha80,pha83]=load_wave_sys3_FPGA_ref_phase(bgdata,source,detect,sddist_matrix)

if length(bgdata) > 9216
  data_74=bgdata(1:4608,1:detect+1);  %512*9=4608
  data_78=bgdata(4608*1+1:4608*2,1:detect+1);
  data_80=bgdata(4608*2+1:4608*3,1:detect+1);
  data_83=bgdata(4608*3+1:4608*4,1:detect+1);

  for i=1:source
  eval(['data74_s',num2str(i),'=data_74(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
  eval(['data78_s',num2str(i),'=data_78(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
  eval(['data80_s',num2str(i),'=data_80(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
  eval(['data83_s',num2str(i),'=data_83(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
  end
else
  data_74=bgdata(1:2304,1:detect+1);  %256*9=2304
  data_78=bgdata(2304*1+1:2304*2,1:detect+1);
  data_80=bgdata(2304*2+1:2304*3,1:detect+1);
  data_83=bgdata(2304*3+1:2304*4,1:detect+1);

  for i=1:source
  eval(['data74_s',num2str(i),'=data_74(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
  eval(['data78_s',num2str(i),'=data_78(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
  eval(['data80_s',num2str(i),'=data_80(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
  eval(['data83_s',num2str(i),'=data_83(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
  end
end

for ii=1:source
  eval(['ref=data74_s',num2str(ii),'(:,15);']);
  ref=ref-mean(ref);
  ref_h = hilbert(ref);
  ref_phase=mean(unwrap(angle(ref_h)));
 
  for jj=1:detect
  eval(['wv=data74_s',num2str(ii),'(:,',num2str(jj),');'])
  wv_h=hilbert(wv);
  amp = mean(abs(wv_h));
  phase= mean(unwrap(angle(wv_h)));
  amp74(ii,jj)=amp/1000; %convert from mV to V 
  pha74(ii,jj)=mod(ref_phase-phase,2*pi);
  end
end

for ii=1:source
  eval(['ref=data78_s',num2str(ii),'(:,15);']);
  ref=ref-mean(ref);
  ref_h = hilbert(ref);
  ref_phase=mean(unwrap(angle(ref_h)));
 
  for jj=1:detect
  eval(['wv=data78_s',num2str(ii),'(:,',num2str(jj),');'])
  wv_h=hilbert(wv);
  amp = mean(abs(wv_h));
  phase= mean(unwrap(angle(wv_h)));
  amp78(ii,jj)=amp/1000; %convert from mV to V 
  pha78(ii,jj)=mod(ref_phase-phase,2*pi);
  end
end

for ii=1:source
  eval(['ref=data80_s',num2str(ii),'(:,15);']);
  ref=ref-mean(ref);
  ref_h = hilbert(ref);
  ref_phase=mean(unwrap(angle(ref_h)));
 
  for jj=1:detect
  eval(['wv=data80_s',num2str(ii),'(:,',num2str(jj),');'])
  wv_h=hilbert(wv);
  amp = mean(abs(wv_h));
  phase= mean(unwrap(angle(wv_h)));
  amp80(ii,jj)=amp/1000; %convert from mV to V 
  pha80(ii,jj)=mod(ref_phase-phase,2*pi);
  end
end

for ii=1:source
  eval(['ref=data83_s',num2str(ii),'(:,15);']);
  ref=ref-mean(ref);
  ref_h = hilbert(ref);
  ref_phase=mean(unwrap(angle(ref_h)));
 
  for jj=1:detect
  eval(['wv=data83_s',num2str(ii),'(:,',num2str(jj),');'])
  wv_h=hilbert(wv);
  amp = mean(abs(wv_h));
  phase= mean(unwrap(angle(wv_h)));
  amp83(ii,jj)=amp/1000; %convert from mV to V 
  pha83(ii,jj)=mod(ref_phase-phase,2*pi);
  end
end

cross_74=[
1.0659 1.4131 -3.0785 0.2237 1.7779 1.5177 2.6297 2.3227 2.9911 -2.7114 2.6756 1.8564 -2.3681 -3.0033
0.9426 1.1292 -3.6805 0.1236 1.6110 1.4346 2.3922 2.0448 2.7830 -2.8654 2.4488 1.8349 -2.6776 -3.1099
0.9156 1.2657 -3.6743 0.0993 1.6566 1.4991 2.5073 1.9940 2.8256 -2.8851 2.5416 1.8695 -2.6784 -3.0410
1.0181 1.5059 -3.0314 0.1794 1.9334 1.6230 2.8015 2.7584 2.8906 -2.6870 2.6922 1.9911 -2.2019 -2.9342
0.6326 1.0549 -3.6584 -0.1568 1.4311 1.2649 2.3562 1.9067 2.5653 -3.0520 2.3935 1.6667 -2.8618 -3.2857
1.1251 1.6676 -2.9664 0.4178 1.9141 1.8306 2.9128 2.3776 3.0731 -2.5754 2.8021 2.3057 -2.2391 -2.7075
1.3369 1.7664 -2.7644 0.5472 2.1147 2.0058 3.0032 2.5870 3.1931 -2.4357 3.0306 2.3245 -2.1161 -2.5736
1.1194 1.6166 -2.8883 0.2771 1.9766 1.8422 2.9656 2.3104 2.9831 -2.3779 2.7483 2.2272 -2.3248 -2.7800
0.9699 1.4787 -2.7182 0.1707 1.8563 1.6990 2.7341 2.1842 2.8607 -2.3397 2.3854 1.5037 -2.4757 -2.8453
];

slope_74=[
0.6346  0.6021  0.6784  0.4544  0.5405  0.5196  0.5846  0.4810  0.5515  0.6281  0.5826  0.4769  0.5542  0.6044 
0.6277  0.6217  0.7502  0.4460  0.5430  0.5082  0.6023  0.5013  0.5628  0.6279  0.5971  0.4586  0.5833  0.5975 
0.6426  0.6080  0.7590  0.4587  0.5454  0.5060  0.5908  0.5181  0.5659  0.6398  0.5892  0.4577  0.5921  0.5928 
0.6465  0.5875  0.6632  0.4665  0.5196  0.5060  0.5630  0.4235  0.5759  0.6285  0.5854  0.4582  0.5378  0.5957 
0.6490  0.6015  0.7113  0.4605  0.5428  0.5048  0.5762  0.4945  0.5668  0.6253  0.5730  0.4508  0.5791  0.5920 
0.6548  0.5906  0.6800  0.4546  0.5511  0.5005  0.5732  0.5062  0.5712  0.6384  0.5973  0.4384  0.5675  0.5854 
0.6475  0.5976  0.6727  0.4597  0.5456  0.4983  0.5861  0.4989  0.5796  0.6377  0.5822  0.4561  0.5722  0.5901 
0.6473  0.5911  0.6565  0.4729  0.5338  0.4915  0.5568  0.5090  0.5815  0.5941  0.5971  0.4351  0.5746  0.5915 
0.6570  0.5942  0.6081  0.4713  0.5355  0.4974  0.5779  0.5103  0.5816  0.5680  0.6384  0.5458  0.5807  0.5851
];

cross_78=[
-0.8053 -0.6390 1.2022 -2.1822 -0.1274 -0.7032 0.6342 -0.3483 0.9583 1.5416 0.6582 -0.4800 1.9440 1.2734
-1.0161 -0.7545 0.5350 -2.2756 -0.4349 -0.8905 0.5028 -0.4702 0.7187 1.3612 0.4981 -0.5846 1.6000 1.1386
-0.8924 -0.7037 0.6660 -2.2399 -0.4105 -0.8255 0.5320 -0.4234 0.8507 1.3872 0.5143 -0.5738 1.7455 1.2031
-0.8531 -0.5628 1.1051 -2.0382 -0.2736 -0.7644 0.7392 -0.3090 1.0040 1.5785 0.6775 -0.4072 1.9648 1.2439
-1.2187 -0.9460 0.4517 -2.4148 -0.5731 -1.0595 0.2592 -0.5844 0.5963 1.2687 0.3462 -0.7810 1.4256 0.9312
-0.7436 -0.4493 1.3103 -1.9785 0.0344 -0.5356 0.8485 -0.1826 1.1208 1.7601 0.8289 -0.2549 1.9905 1.5133
-0.4802 -0.2051 1.4920 -1.8150 0.0434 -0.3623 1.0813 -0.0485 1.2950 1.9252 0.9904 -0.1509 2.1708 1.6211
-0.7232 -0.5106 1.4124 -1.9460 -0.0923 -0.5374 0.8107 -0.1339 1.0612 1.8649 0.6925 -0.1819 1.9319 1.3908
-0.7939 -0.5650 1.5595 -2.1111 -0.1941 -0.6935 0.6544 -0.3164 0.9792 1.9459 0.3577 -0.6552 1.7424 1.3662
];

slope_78=[
0.5124  0.5047  0.5690   0.4123  0.4270  0.4414  0.4822   0.4817  0.4545   0.5314   0.4838   0.4180  0.4483   0.5034  
0.5224  0.5019  0.6581   0.4018  0.4534  0.4475  0.4793   0.4780  0.4707   0.5335   0.4833   0.4106  0.4811   0.5009  
0.5086  0.5016  0.6411   0.4052  0.4583  0.4457  0.4860   0.4787  0.4570   0.5377   0.4904   0.4171  0.4633   0.4981  
0.5257  0.4980  0.5836   0.3910  0.4575  0.4572  0.4712   0.4804  0.4510   0.5285   0.4842   0.4106  0.4540   0.5109  
0.5240  0.5009  0.6361   0.3914  0.4426  0.4435  0.4911   0.4626  0.4550   0.5161   0.4778   0.4102  0.4761   0.5017  
0.5363  0.5075  0.5765   0.4105  0.4306  0.4476  0.4827   0.4888  0.4602   0.5245   0.4870   0.4140  0.4735   0.4938  
0.5166  0.4926  0.5730   0.4108  0.4594  0.4451  0.4686   0.4925  0.4573   0.5227   0.4867   0.4212  0.4686   0.5028  
0.5237  0.5093  0.5491   0.3997  0.4483  0.4411  0.4827   0.4733  0.4654   0.4981   0.5031   0.3889  0.4763   0.5097  
0.5173  0.5014  0.5038   0.4083  0.4435  0.4491  0.4904   0.4856  0.4577   0.4619   0.5350   0.4524  0.4894   0.4947
];

cross_80=[
1.6035 1.7669 -2.7034 0.2485 2.0267 1.7220 2.9668 2.1201 3.4340 -2.3388 3.0215 1.9259 -1.9357 -2.6847
1.4841 1.6697 -3.2904 0.1730 1.9597 1.5613 2.8925 1.9285 3.2108 -2.4836 2.8507 1.8352 -2.2748 -2.7380
1.4995 1.6706 -3.1876 0.1483 2.0926 1.6095 3.0422 2.0313 3.2451 -2.4673 2.8411 1.8846 -2.1375 -2.6553
1.6582 1.8390 -2.7256 0.3084 2.2521 1.7629 3.1702 2.1554 3.4574 -2.2796 3.0779 1.9537 -1.8322 -2.5894
1.2168 1.5524 -3.3794 0.0413 1.7445 1.3830 2.7227 1.7978 2.9400 -2.6377 2.6032 1.7011 -2.4434 -2.9529
1.7299 2.0647 -2.6210 0.3987 2.3316 1.8776 3.3566 2.2362 3.5170 -2.0865 3.2985 2.1120 -1.8266 -2.3806
1.9031 2.3897 -2.4467 0.6379 2.4790 2.1111 3.5072 2.3765 3.7360 -1.9801 3.3501 2.3290 -1.7467 -2.2776
1.6319 1.9668 -2.5153 0.3767 2.2819 1.8568 3.2060 2.1758 3.5134 -2.0168 3.0091 2.2065 -1.8742 -2.4475
1.5965 1.9118 -2.3511 0.1835 2.3137 1.7205 3.2460 2.1422 3.2806 -1.9987 2.7861 1.7499 -2.0761 -2.4795
];

slope_80=[
0.5210 0.5129 0.5854 0.4193 0.4824 0.4482 0.5068 0.4793 0.4511 0.5387 0.4991 0.4265 0.4554 0.5251
0.5162 0.5052 0.6583 0.4075 0.4661 0.4497 0.4959 0.4875 0.4663 0.5361 0.5006 0.4167 0.4893 0.5081
0.5208 0.5168 0.6513 0.4205 0.4525 0.4516 0.4794 0.4783 0.4682 0.5416 0.5112 0.4154 0.4745 0.5030
0.5188 0.5108 0.5899 0.4141 0.4443 0.4455 0.4784 0.4780 0.4532 0.5344 0.4943 0.4260 0.4488 0.5101
0.5302 0.4937 0.6422 0.3954 0.4703 0.4489 0.4925 0.4782 0.4792 0.5300 0.5126 0.4056 0.4840 0.5116
0.5340 0.4970 0.5964 0.4273 0.4630 0.4570 0.4760 0.4936 0.4731 0.5270 0.4839 0.4296 0.4734 0.5065
0.5280 0.4704 0.5958 0.4136 0.4664 0.4445 0.4766 0.4983 0.4602 0.5342 0.5017 0.4165 0.4844 0.5155
0.5417 0.5042 0.5696 0.4230 0.4643 0.4529 0.4957 0.4980 0.4655 0.5062 0.5250 0.3996 0.4732 0.5112
0.5314 0.4988 0.5234 0.4391 0.4385 0.4587 0.4681 0.4844 0.4868 0.4829 0.5413 0.4614 0.4891 0.4987
];

cross_83=[
-1.4013 -1.4594 0.3932 3.3907 -0.8042 -1.2849 0.1610 -0.9762 0.3068 1.0302 0.0861 -1.1211 1.3854 0.6827
-1.5099 -1.3130 -0.2190 3.3722 -1.0813 -1.4347 0.0319 -0.9446 0.1263 0.8109 -0.1234 -1.1379 0.9752 0.6581
-1.4291 -1.3975 0.0643 3.3935 -0.9249 -1.4666 0.0474 -1.0237 0.2206 0.9455 -0.1060 -1.2569 1.1623 0.6823
-1.3854 -1.1516 0.5000 3.5510 -0.8939 -1.3588 0.1136 -0.8519 0.4479 1.0109 0.1536 -1.0185 1.4828 0.8221
-1.6689 -1.5726 -0.1380 3.0567 -1.2483 -1.7360 -0.1497 -1.2777 0.0981 0.6993 -0.1975 -1.3685 0.7965 0.4334
-1.1915 -1.1443 0.6197 3.7533 -0.7052 -1.2113 0.4370 -0.7561 0.6045 1.1889 0.2882 -0.8267 1.5218 0.9291
-0.9158 -0.8445 0.7558 3.8175 -0.5260 -1.0404 0.5126 -0.6117 0.8166 1.4887 0.4259 -0.7862 1.5546 1.0938
-1.3242 -1.0995 0.8092 3.7391 -0.8139 -1.1783 0.4351 -0.7527 0.5656 1.2653 0.2001 -0.8547 1.3847 0.8399
-1.4255 -1.1233 0.9784 3.5161 -0.5799 -1.3479 0.2170 -0.9144 0.4642 1.4054 -0.1564 -1.2698 1.1943 0.7301
];

slope_83=[
0.4797 0.5120 0.5763 0.3927 0.4048 0.3973 0.4218 0.4476 0.4254 0.4789 0.4438 0.3867 0.3995 0.4649
0.4714 0.4611 0.6556 0.3681 0.4242 0.3979 0.4200 0.4150 0.4266 0.4880 0.4529 0.3623 0.4471 0.4440
0.4667 0.4791 0.6113 0.3741 0.4052 0.4137 0.4276 0.4403 0.4227 0.4734 0.4591 0.3930 0.4227 0.4486
0.4830 0.4657 0.5567 0.3718 0.4244 0.4179 0.4397 0.4308 0.4044 0.4886 0.4372 0.3741 0.3970 0.4453
0.4694 0.4731 0.6041 0.3945 0.4216 0.4196 0.4184 0.4423 0.3999 0.4755 0.4350 0.3702 0.4459 0.4511
0.4767 0.4920 0.5630 0.3670 0.4187 0.4235 0.4116 0.4465 0.4072 0.4858 0.4437 0.3717 0.4149 0.4592
0.4535 0.4664 0.5654 0.3824 0.4168 0.4218 0.4285 0.4481 0.3967 0.4578 0.4457 0.3893 0.4355 0.4568
0.4926 0.4737 0.5180 0.3601 0.4336 0.4098 0.4042 0.4373 0.4093 0.4630 0.4491 0.3627 0.4281 0.4646
0.4918 0.4612 0.4689 0.3837 0.3708 0.4206 0.4261 0.4471 0.4043 0.4153 0.4867 0.4154 0.4413 0.4668
];

 % version 4, shift the change
 cro_74=[-1 -0.8 -.5  0.8  0 -0.8 0 0.5 -0.5  -1.5 0 0  0  -0.8];
 cro_78=[-1 -1 -0.5 0.5 -1 -1 0 0 -0.8 -1.5 0. 0 -1 -1];
 cro_80=[-0 0 0  0.5  0 -.5 0.5 0.5 0  -1.5  0.3  0.6 0 -0];
 cro_83=[-0.2 0  0  0.8  0.4 -.6 0.5 1.0 -0.  -1.5  0.  .5 0 -0.];
 
 for ii=1:source
  for jj=1:detect
  pha=pha74(ii,jj);
  temp=polyval([mean(slope_74(:,jj)) mean(cross_74(:,jj))],sddist_matrix(ii,jj));
  if pha>temp+pi
  pha74(ii,jj)=pha-2*pi;
  end
  if pha<temp-pi
  pha74(ii,jj)=pha+2*pi;
  end
  pha74(ii,jj)=pha74(ii,jj)-mean(cross_74(:,jj))+cro_74(jj);
  end
end

for ii=1:source
  for jj=1:detect
  pha=pha78(ii,jj);
  temp=polyval([mean(slope_78(:,jj)) mean(cross_78(:,jj))],sddist_matrix(ii,jj));
  if pha>temp+pi
  pha78(ii,jj)=pha-2*pi;
  end
  if pha<temp-pi
  pha78(ii,jj)=pha+2*pi;
  end
  pha78(ii,jj)=pha78(ii,jj)-mean(cross_78(:,jj))+cro_78(jj);
  end  
end

 for ii=1:source
  for jj=1:detect
  pha=pha80(ii,jj);
  temp=polyval([mean(slope_80(:,jj)) mean(cross_80(:,jj))],sddist_matrix(ii,jj));
  if pha>temp+pi
  pha80(ii,jj)=pha-2*pi;
  end
  if pha<temp-pi
  pha80(ii,jj)=pha+2*pi;
  end
  pha80(ii,jj)=pha80(ii,jj)-mean(cross_80(:,jj))+cro_80(jj);
  end
 end

 for ii=1:source
  for jj=1:detect
  pha=pha83(ii,jj);
  temp=polyval([mean(slope_83(:,jj)) mean(cross_83(:,jj))],sddist_matrix(ii,jj));
  if pha>temp+pi
  pha83(ii,jj)=pha-2*pi;
  end
  if pha<temp-pi
  pha83(ii,jj)=pha+2*pi;
  end
  pha83(ii,jj)=pha83(ii,jj)-mean(cross_83(:,jj))+cro_83(jj);
  end
 end 
