%transform wave to amplitude and phase
function [amp74,amp78,amp80,amp83,pha74,pha78,pha80,pha83]=load_wave_sys2_FPGA_ref_phase(bgdata,source,detect,sddist_matrix)
% channel=detect+1;
% s_total = size(bgdata,1)/channel;  %number of one set data

if length(bgdata) > 9216
  data_74=bgdata(1:4608,1:detect+1);    %512*9=4608
  data_78=bgdata(4608*1+1:4608*2,1:detect+1);
  data_80=bgdata(4608*2+1:4608*3,1:detect+1);
  data_83=bgdata(4608*3+1:4608*4,1:detect+1);

  for i=1:source
    eval(['data74_s',num2str(i),'=data_74(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
    eval(['data78_s',num2str(i),'=data_78(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
    eval(['data80_s',num2str(i),'=data_80(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
    eval(['data83_s',num2str(i),'=data_83(512*(',num2str(i),'-1)+1:512*',num2str(i),',1:detect+1);']);
  end
else
  data_74=bgdata(1:2304,1:detect+1);    %256*9=2304
  data_78=bgdata(2304*1+1:2304*2,1:detect+1);
  data_80=bgdata(2304*2+1:2304*3,1:detect+1);
  data_83=bgdata(2304*3+1:2304*4,1:detect+1);

  for i=1:source
    eval(['data74_s',num2str(i),'=data_74(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
    eval(['data78_s',num2str(i),'=data_78(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
    eval(['data80_s',num2str(i),'=data_80(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
    eval(['data83_s',num2str(i),'=data_83(256*(',num2str(i),'-1)+1:256*',num2str(i),',1:detect+1);']);
  end
end

for ii=1:source
  eval(['ref=data74_s',num2str(ii),'(:,15);']);
  ref_h = hilbert(ref);
  ref_phase=mean(unwrap(angle(ref_h(6:251))));
 
  for jj=1:detect
    eval(['wv=data74_s',num2str(ii),'(:,',num2str(jj),');'])
    wv_h=hilbert(wv);
    amp = mean(abs(wv_h(6:251)));
    phase= mean(unwrap(angle(wv_h(6:251))));
    amp74(ii,jj)=amp/1000; %convert from mV to V 
    pha74(ii,jj)=mod(phase-ref_phase, 2*pi);
  end
end

for ii=1:source
  eval(['ref=data78_s',num2str(ii),'(:,15);']);
  ref_h = hilbert(ref);
  ref_phase=mean(unwrap(angle(ref_h(6:251))));
 
  for jj=1:detect
    eval(['wv=data78_s',num2str(ii),'(:,',num2str(jj),');'])
    wv_h=hilbert(wv);
    amp = mean(abs(wv_h(6:251)));
    phase= mean(unwrap(angle(wv_h(6:251))));
    amp78(ii,jj)=amp/1000; %convert from mV to V 
    pha78(ii,jj)=mod(phase-ref_phase, 2*pi);
  end
end

for ii=1:source
  eval(['ref=data80_s',num2str(ii),'(:,15);']);
  ref_h = hilbert(ref);
  ref_phase=mean(unwrap(angle(ref_h(6:251))));
 
  for jj=1:detect
    eval(['wv=data80_s',num2str(ii),'(:,',num2str(jj),');'])
    wv_h=hilbert(wv);
    amp = mean(abs(wv_h(6:251)));
    phase= mean(unwrap(angle(wv_h(6:251))));
    amp80(ii,jj)=amp/1000; %convert from mV to V 
    pha80(ii,jj)=mod(phase-ref_phase, 2*pi);
  end
end

for ii=1:source
  eval(['ref=data83_s',num2str(ii),'(:,15);']);
  ref_h = hilbert(ref);
  ref_phase=mean(unwrap(angle(ref_h(6:251))));
 
  for jj=1:detect
    eval(['wv=data83_s',num2str(ii),'(:,',num2str(jj),');'])
    wv_h=hilbert(wv);
    amp = mean(abs(wv_h(6:251)));
    phase= mean(unwrap(angle(wv_h(6:251))));
    amp83(ii,jj)=amp/1000; %convert from mV to V 
    pha83(ii,jj)=mod(phase-ref_phase, 2*pi);
  end
end

cross_74=[
-1.7731 0.6258 -0.9924 1.8395 0.7245 2.7665 2.7723 -0.1167 -2.4525 -0.1360 -0.4491 -0.0340 0.1902 0.3867
-3.0663 0.5985 -0.8443 1.9132 0.6202 2.8007 2.2839 -0.2965 -2.4022 -0.1336 -0.6259 0.0812 0.4185 0.3488
 -3.1514 0.3509 -1.2939 1.5334 0.3534 -2.6433 0.8623 -0.4110 -3.0376 -0.4406 -0.8544 -0.2703 0.1377 0.1506
 -2.7558 0.8743  -0.6600 2.1880 1.0075  2.7590  3.1816 0.3024 -2.2033 0.1690 -0.1708 0.3570 0.5342 0.7303
 -1.3608 0.6308 -0.8436 1.7896 0.6348 -2.2469  2.7732 -0.2800 -1.9777  -0.2083 -0.5708 0.0338 0.5009 0.5016
 -2.5935 1.1652 -0.5297 2.4218 1.3565 -3.3441 2.5308 0.2402 -1.6653 0.4350 0.0846 0.5576 0.9040 0.9988
-2.4045 1.5450  0.3782 2.4487 1.4235 -1.4803 3.4417 0.4889 -1.3690 0.5783 0.1742 0.6306 1.1944  1.1960
-2.0959 1.1376 -0.3185  2.0425 0.9738 -2.3928 3.4051 0.8041 -2.1680 0.1669 -0.2583 0.3866 0.5030 0.7323
-2.3551 1.5794 -0.1905 2.4943 1.5075 -2.9611 2.2227 0.4603 -1.8148 0.6023 0.1936 0.6427 1.2675 1.2401
];

slope_74=[ 
0.7008 0.6431  0.8243  0.6391  0.6365  0.8659  0.6980  0.8147  0.8458  0.5610  0.5403  0.5817  0.7352  0.6594 
1.0631 0.6441  0.8066  0.6277  0.6513  0.8744  0.7689  0.8374  0.8310  0.5527  0.5711  0.5580  0.7001  0.6661  
1.0301 0.6373  0.8390  0.6420  0.6473  0.6963  0.9424  0.8154  0.8744  0.5541  0.5584  0.5654  0.6953  0.6476 
1.0686 0.6575  0.8431  0.6393  0.6458  0.9403  0.6900  0.8056  0.8420  0.5614  0.5563  0.5670  0.7371  0.6620
0.7960 0.6335  0.8151  0.6417  0.6454  0.6809  0.6930  0.8372  0.7595  0.5549  0.5532  0.5535  0.6828  0.6372 
1.0732 0.6432  0.8475  0.6343  0.6209  0.9394  0.8184  0.8449  0.7978  0.5429  0.5426  0.5635  0.7117  0.6488 
1.0733 0.6022  0.7328  0.6565  0.6377  0.6783  0.6974  0.8356  0.7687  0.5411  0.5514  0.5775  0.6964  0.6407  
0.9695 0.6064  0.7885  0.6578  0.6445  0.7594  0.6483  0.7331  0.8205  0.5484  0.5624  0.5537  0.7409  0.6552  
1.0734 0.6042  0.8291  0.6553  0.6304  0.9184  0.8983  0.8450  0.8397  0.5467  0.5550  0.5807  0.6911  0.6497 
];

cross_78=[  
-0.3833  1.7354  0.8761  -3.0577  1.9363 -1.2312  -1.8823 1.7921 -0.9492 0.9586 0.3865 1.0423 1.3047 1.5321
-0.1908 1.8112 1.0029 -3.1123 1.9640 -1.3965 -2.6090 1.7349  -1.3633 0.8741 0.4211 1.0615 1.5627 1.5944
-0.5193 1.4567 0.8172 -3.3444 1.6554 -1.2737 -2.7435 1.5369 -1.9741 0.5721 0.1621 0.7133 1.2637 1.2358
0.5986 2.0842 1.3671 -2.9419 2.0891 -0.9293 -1.6773 2.2006 -1.2952 1.1743 0.8067 1.3735 1.6425 1.9118
-0.1403 1.7730 1.1855 -3.0566 1.7770 -0.6673 -2.2004 1.6325 -0.8966 0.7877 0.4164 1.0396  1.5920 1.5337
1.2633 2.2672 0.8635 -2.7260 2.4927 -0.7914 -1.8506 2.3469 -0.5557 1.3341 0.9832 1.6301 2.0799 2.1068
0.6664 2.5952 1.8068 -2.6268 2.5870 -0.0406 -1.1875 2.5931 -0.2623 1.5002 1.1252 1.7286  2.3967 2.2780
 -0.0026 2.1970 1.3562 -2.9431 2.1853  -1.0119 -1.5677 2.3279 -0.9209 1.0970 0.8035 1.3949 1.7520 1.8886
0.6465 2.7215 1.8028 -2.6161 2.6762 -0.4779 -1.6348 2.4890 -0.6839 1.5993 1.1210 1.6339 2.4722 2.3488
];

slope_78=[ 
0.5527  0.5315   0.6053  0.4884   0.5111  0.5714 0.5099  0.5979 0.6852  0.4453   0.4715    0.4725  0.6234  0.5397 
0.6900  0.5177   0.5960   0.5002  0.5047   0.6183  0.6234  0.6030   0.7450  0.4549   0.4690   0.4675    0.5876 0.5287 
 0.6916  0.5275  0.5743   0.4858  0.5082  0.5405  0.5919  0.5884 0.7890  0.4535    0.4608    0.4735   0.5868 0.5445 
 0.6209   0.5321   0.5945 0.5313    0.5442   0.5977   0.5283  0.5911   0.7818  0.4621   0.4624    0.4693   0.6297 0.5379  
0.6755  0.5175  0.5546  0.4817  0.5341    0.4937  0.5496  0.6161   0.6690    0.4585    0.4614    0.4586   0.5786  0.5412 
 0.5508 0.5337    0.7026 0.5267   0.5099  0.6077  0.5814  0.5943   0.7025  0.4604  0.4632   0.4569  0.5909 0.5402  
0.6670   0.5011   0.5815 0.5355 0.5187    0.5128  0.5064  0.5796   0.6704   0.4577    0.4636   0.4650   0.5698   0.5376  
0.7147 0.5051  0.5960   0.5244  0.5215  0.6025  0.5107  0.5664   0.7009  0.4630   0.4546  0.4577   0.6081 0.5363  
0.6778   0.4882   0.5893   0.5433  0.5141   0.5957 0.5844  0.6110   0.7388  0.4498   0.4721   0.4881   0.5649   0.5393
];

cross_80=[
2.2898 -1.8509 -2.9528 -0.5127 -1.8130 0.8810 0.5567 -1.7653 1.3295 -2.7326 -2.9943 -2.4737 -2.2935 -2.0674
2.5263 -1.9214 -2.5386 -0.6976 -1.7426 1.4906 0.3680 -1.9432 1.3474 -2.8029 -3.0041 -2.4001 -2.1627 -2.1604
2.1962 -2.2259 -2.8043 -0.9320 -1.9546 1.1276 0.1122 -2.0941 0.9312 -3.1734 -3.3864 -2.7997 -2.4054 -2.3755
2.0880 -1.4640 -2.2144 -0.2152 -1.3921 1.8705 0.6912 -1.4035 1.6029 -2.4064 -2.7214 -2.1323 -1.9935 -1.7118
2.5779 -1.7637 -2.4305 -0.6118 -1.8827 1.7149 0.3508 -2.1435 1.7829 -2.8928 -3.1076 -2.5300 -2.0230 -1.9962
2.5320 -1.2409 -2.8385 -0.0011 -1.1322 2.0663 0.9446 -1.3065 2.2223 -2.2599 -2.5290 -1.9335 -1.6269 -1.5414
3.2099 -1.0392 -1.7782 0.1619 -1.0265 2.2285 1.2546 -1.1594 2.4032 -2.1723 -2.3215 -1.8761 -1.2993 -1.2994
2.7823 -1.5435 -2.0982 -0.3161 -1.4423 1.7830 1.3169 -1.2870 1.6687 -2.4862 -2.7812 -2.1762 -1.9432 -1.7166
2.6378 -1.0944 -1.9101 0.4330 -0.9944 2.1525 1.1614 -1.4050 2.1018 -2.0545 -2.3736 -1.8689 -1.2355 -1.2306
];

slope_80=[
0.5808 0.5561 0.6636  0.5475 0.5628 0.6895 0.5712 0.6122  0.7918 0.4887 0.4609 0.4861 0.6449  0.5642 
0.7085 0.5663 0.6085  0.5800 0.5465 0.6140 0.5958 0.6487  0.7769 0.4968 0.4652 0.4717 0.6292  0.5818 
0.7149 0.5677 0.6032  0.5685 0.5341 0.6223 0.5856 0.6223  0.7822 0.5072 0.4770 0.4879 0.6200  0.5707 
0.8355 0.5477 0.6130  0.5526 0.5482 0.6081 0.5991 0.6168  0.7760 0.4871 0.4788 0.4817 0.6567  0.5658 
0.7008 0.5348 0.5863  0.5608 0.5704 0.5690 0.5900 0.6728  0.7033 0.5028 0.4787 0.4818 0.6007  0.5492 
0.7950 0.5435 0.7410  0.5507 0.5394 0.6056 0.5903 0.6289  0.7187 0.4915 0.4765 0.4785 0.6297  0.5716 
0.7202 0.5386 0.6060  0.5501 0.5506 0.6059 0.5655 0.6283  0.7085 0.5011 0.4675 0.4941 0.6069  0.5533 
0.7265 0.5591 0.5898  0.5673 0.5533 0.6168 0.4955 0.5967  0.7487 0.4903 0.4803 0.4811 0.6461  0.5626 
0.8189 0.5548 0.6343  0.5099 0.5522 0.6259 0.5928 0.6848 0.7628 0.4884 0.4820 0.5006 0.6049  0.5591
];

cross_83=[
1.0523 3.2355 2.1170 -1.7886 -2.7860 -0.3298 -0.8588 2.9938 0.7130 2.4274 2.0257 2.6005 2.5938 2.5384
1.2594 3.0985 2.2260 -1.8292 -2.9005 0.2573 -0.8446 2.8965 0.5890 2.1905 1.8902 2.5625 2.7348 2.5534
1.2949 3.1481 1.8261 -2.0499 -3.0649 0.0733 -1.3789 2.7951 -0.3471 2.1015 1.7094 2.2675 2.4020 2.2618
1.4948 3.6796 2.4750 -1.4246 -2.6246 0.6292 -0.4405 3.4151 0.6097 2.6238 2.4289 2.9434 2.8481 2.8942
1.7455 3.2486 2.2131 -1.9325 -2.9329 0.2455 -0.8176 2.9590 0.7145 2.1260 1.9807 2.5672 2.6822 2.5356
1.6851 3.9261 2.5070 -1.2168 -2.2696 0.8531 -0.2175 3.5153 1.0641 2.8127 2.4965 3.0984 3.2196 3.0985
2.3562 4.0213 3.0285 -1.3220 -2.2516 0.9702 0.0256 3.6345 1.3791 3.0010 2.6823 3.0855 3.4911 3.2806
2.0084 3.6344 2.6411 -1.5811 -2.5741 0.6477 -0.4821 3.4324 0.7044 2.5540 2.1773 2.9033 2.8902 2.8693
1.9615 4.0928 2.9248 -1.0930 -2.1646 0.9945 0.1595 3.6760 1.0792 2.9552 2.5665 3.2246 3.6087 3.4391
];

slope_83=[
0.4411 0.4964 0.5278 0.5046 0.4623 0.5492 0.4705 0.5331 0.6429 0.4082 0.4080 0.4305 0.5411 0.5038
0.5910 0.5170 0.5161 0.5097 0.4798 0.4851 0.4719 0.5527 0.6483 0.4445 0.4306 0.4326 0.5226 0.5040
0.5362 0.4570 0.5384 0.4938 0.4583 0.4539 0.5024 0.5163 0.7479 0.4086 0.4144 0.4312 0.5279 0.5026
0.6086 0.4786 0.5419 0.4996 0.4946 0.4802 0.4590 0.5246 0.6990 0.4302 0.4003 0.4214 0.5626 0.5046
0.5056 0.4922 0.5205 0.5291 0.4884 0.4806 0.4583 0.5372 0.6424 0.4567 0.4205 0.4232 0.5303 0.5038
0.6093 0.4708 0.5682 0.4984 0.4713 0.4766 0.4508 0.5380 0.6643 0.4316 0.4251 0.4281 0.5347 0.5041
0.5321 0.4818 0.5093 0.5493 0.4960 0.4852 0.4300 0.5534 0.6333 0.4217 0.4197 0.4565 0.5180 0.4988
0.5290 0.4852 0.5072 0.5242 0.4835 0.4730 0.4594 0.5235 0.6606 0.4353 0.4410 0.4227 0.5553 0.5063
0.5992 0.4815 0.5354 0.5197 0.4919 0.4893 0.4207 0.5529 0.6918 0.4438 0.4515 0.4413 0.5074 0.4859
];

% version 4, shift the change
 cro_74=[-1 0 -1 -0.5 0 0 -2 -1 0 0 0.5 0 0 0];
 cro_78=[0 2.0 0 1.0 0.6  0 0 0 0 0.8 1.0 0.8 0 0];
 cro_80=[0 1.5 0 0.5 0 -0.5 -0.5 -0.4 0 0 0.5 0.5 0 0];
 cro_83=[0 1 0 0.4 0  0 0 0 0 0.8 0.8 0.5 0 0];
 
 for ii=1:source
  for jj=1:detect
    pha=pha74(ii,jj);
    temp=polyval([mean(slope_74(:,jj)) mean(cross_74(:,jj))],sddist_matrix(ii,jj));
    if pha>temp+pi
    pha74(ii,jj)=pha-2*pi;
    end
    if pha<temp-pi
    pha74(ii,jj)=pha+2*pi;
    end
    pha74(ii,jj)=pha74(ii,jj)-mean(cross_74(:,jj))+cro_74(jj);
  end
end

for ii=1:source
  for jj=1:detect
    pha=pha78(ii,jj);
    temp=polyval([mean(slope_78(:,jj)) mean(cross_78(:,jj))],sddist_matrix(ii,jj));
    if pha>temp+pi
    pha78(ii,jj)=pha-2*pi;
    end
    if pha<temp-pi
    pha78(ii,jj)=pha+2*pi;
    end
    pha78(ii,jj)=pha78(ii,jj)-mean(cross_78(:,jj))+cro_78(jj);
  end  
end

 for ii=1:source
  for jj=1:detect
    pha=pha80(ii,jj);
    temp=polyval([mean(slope_80(:,jj)) mean(cross_80(:,jj))],sddist_matrix(ii,jj));
    if pha>temp+pi
    pha80(ii,jj)=pha-2*pi;
    end
    if pha<temp-pi
    pha80(ii,jj)=pha+2*pi;
    end
    pha80(ii,jj)=pha80(ii,jj)-mean(cross_80(:,jj))+cro_80(jj);
  end
 end

 for ii=1:source
  for jj=1:detect
    pha=pha83(ii,jj);
    temp=polyval([mean(slope_83(:,jj)) mean(cross_83(:,jj))],sddist_matrix(ii,jj));
    if pha>temp+pi
    pha83(ii,jj)=pha-2*pi;
    end
    if pha<temp-pi
    pha83(ii,jj)=pha+2*pi;
    end
    pha83(ii,jj)=pha83(ii,jj)-mean(cross_83(:,jj))+cro_83(jj);
  end
 end   
